---
## Author
author:
  name: Четвергова Мария Викторовна
  degrees: DSc
  orcid: 0000-0002-0877-7063
  email: kulyabov-ds@rudn.ru
  affiliation:
    - name: Российский университет дружбы народов
      country: Российская Федерация
      postal-code: 117198
      city: Москва
      address: ул. Миклухо-Маклая, д. 6

## Title
title: "Администрирование сетевых подсистем"
subtitle: "Лабораторная работа №2"
license: "CC BY"
---

# Цель работы

Приобретение практических навыков по установке и конфигурированию DNS
сервера, усвоение принциповработысистемыдоменныхимён.

# Задание

1. Установите на виртуальной машине server DNS-сервер bind и bind-utils.
2.  Сконфигурируйте на виртуальной машине server кэширующий DNS-сервер.
3. Сконфигурируйте на виртуальной машине server первичный DNS-сервер.
4. При помощи утилит dig и host проанализируйте работу DNS-сервера.
5. Напишите скрипт для Vagrant, фиксирующий действия по установке и конфигурированию DNS-сервера во внутреннем окружении виртуальной машины server. Соответствующим образом внесите изменения в Vagrantfile.

# Выполнение лабораторной работы

## 1. Установка DNS-сервера

 1. Загрузите вашуоперационнуюсистемуиперейдитеврабочийкаталогспроектом:

 ![ Переход в FarManager ](image/1.1.jpg){#fig-001 width=70%}
 
 2. Запуститевиртуальнуюмашинуserver:
vagrant up server

 ![ Запустите виртуальную машину server: ](image/1.2.jpg){#fig-002 width=70%}

 3. Навиртуальноймашинеserver войдитеподсозданнымвамивпредыдущейработе
 пользователем иоткройтетерминал.Перейдитеврежимсуперпользователя:
 sudo-i
 
  ![ Вход в режим суперпользователя  ](image/1.3.jpg){#fig-003 width=70%}
 
 4. Установитеbind иbind-utils:
 dnf-y install bind bind-utils
 
  ![ Установка ](image/1.4.jpg){#fig-004 width=70%}
 
 5. Вкачествеупражненияспомощьюутилитыdig сделайтезапрос,например,кDNS
адресу www.yandex.ru:
 dig www.yandex.ru
 
  ![ Вывод команды dig www.yandex.ru ](image/1.5.jpg){#fig-005 width=70%}
 
 Комментарий к выводу команды: Команда dig www.yandex.ru выполнилась успешно, получив от сервера 37.18.92.5 по UDP подробный ответ с кодом статуса NOERROR. В ответе содержится искомая информация: три IPv4-адреса (77.88.55.88, 5.255.255.77, 77.88.44.55) с TTL 105 секунд, на которые указывает домен www.yandex.ru для балансировки нагрузки, а также авторитативные данные о DNS-серверах домена (ns1.yandex.ru и ns2.yandex.ru) с их собственными IPv4 и IPv6-адресами и значительно более длительным временем жизни записей (TTL 57540 и 58403 секунды), что указывает на стабильную инфраструктуру; также в ответе присутствует опция EDNS, обеспечивающая расширенную функциональность DNS, и используется механизм cookie для безопасности, при этом сам запрос был обработан практически мгновенно.
 
## 2.  Конфигурирование кэширующего DNS-сервера

 1. В отчёте проанализируйте  содержание файлов 
 /etc/resolv.conf
 
 ![ resolv.conf ](image/2.1.1.png){#fig-006 width=70%}
 
 Этот файл не имеет отношения к настройке сервера BIND. Он является системным конфигурационным файлом для DNS-клиента операционной системы. В нем указываются IP-адреса DNS-серверов (строки nameserver), к которым данная машина должна обращаться для разрешения доменных имен, а также параметры вроде доменного суффикса по умолчанию (domain) или порядка поиска (search). На DNS-сервере этот файл обычно указывает на самого себя (nameserver 127.0.0.1), но его основная задача — настроить клиентскую часть системы.
 
 /etc/named.conf
 
  ![ named.conf ](image/2.1.2.png){#fig-007 width=70%}
 
 Это главный конфигурационный файл DNS-сервера BIND (named). Он действует как дирижер для всего сервиса. В нем задаются глобальные параметры: права доступа (ACL), опции работы (порт прослушивания, разрешённые сети-источники запросов, корневые серверы, директории с данными), а также ключевая часть — объявление зон, за которые этот сервер отвечает (авторитативные зоны) или которые он forwards (перенаправляет) другим серверам. Проще говоря, этот файл сообщает BIND, как работать и за какие домены он отвечает.
 
 /var/named/named.ca
 
  ![  named.ca ](image/2.1.3.png){#fig-008 width=70%}
 
 Этот файл, часто называемый "hints-файл", содержит список корневых DNS-серверов интернета. Когда ваш DNS-сервер (резолвер) не знает, куда направить запрос для неизвестного ему домена (например, example.com), он начинает поиск с корневой зоны. Файл named.ca содержит подсказки (hints) в виде NS и A записей этих корневых серверов (a.root-servers.net., b.root-servers.net. и т.д.). BIND обращается к этому файлу, чтобы узнать, с чего начать итеративный процесс разрешения имен для доменов, за которые он не авторитативен.
 
  
 /var/named/named.loopback.
 
   ![ named.loopback.  ](image/2.1.4.png){#fig-009 width=70%}
   
   Это зона прямого просмотра (forward zone) для localhost. Этот файл содержит DNS-записи, которые сопоставляют имя localhost и адрес обратной петли 127.0.0.1 (IPv4) и ::1 (IPv6). Обычно он включает SOA-запись (управление зоной), NS-запись (сервер имен) измененно A (для IPv4) и AAAA (для IPv6) записи, которые указывают на локальную машину. Его purpose — обеспечить корректное разрешение имени localhost в IP-адрес при обращении к самому себе через DNS, что является важной частью функционирования любого хоста.
   
   
 2. ЗапуститеDNS-сервер:
 systemctl start named
 /var/named/named.localhost,
 
   ![ ЗапуститеDNS-сервер:  ](image/2.2.jpg){#fig-010 width=70%}
 
 3. ВключитезапускDNS-серверававтозапускпризагрузкесистемы:
 systemctl enable 
 
 ![  ВключитезапускDNS-серверававтозапускпризагрузкесистемы ](image/2.3.jpg){#fig-011 width=70%}
    
    
 4. Проанализируйтевотчётеотличиеввыведеннойнаэкранинформациипривы
полнениикоманд
 
 dig www.yandex.ru
 
    ![ dig www.yandex.ru ](image/2.4.1.jpg){#fig-012 width=70%}
    
 запрос отправляется DNS-серверу, указанному в системных настройках сети (например, провайдера или корпоративный сервер, в предыдущих примерах это был 37.18.92.5), который действует как рекурсивный резолвер: он самостоятельно проходит всю цепочку запросов (корневые серверы, серверы зоны .ru, серверы Яндекс) и возвращает конечный ответ с IP-адресами, при этом в выводе отсутствует флаг aa (Authoritative Answer), что подтверждает, что ответ был получен не от авторитативного сервера Яндекса, а от кэширующего резолвера.
  
 dig @127.0.0.1 www.yandex.ru
 
    ![  127.0.0.1 www.yandex.ru ](image/2.4.2.jpg){#fig-013 width=70%}
 
 запрос явно направлен на локальный DNS-сервер (127.0.0.1), и здесь возможны два сценария: если локальный сервер настроен как кэширующий рекурсивный резолвер, то он, как и сервер провайдера, вернёт неавторитативный ответ из своего кэша; однако если он не настроен для рекурсии или не имеет записи в кэше, он может вернуть ошибку или перенаправить запрос вышестоящему серверу, но в любом случае ключевое отличие — это принудительное использование локального сервера вместо системного, что используется для его тестирования и отладки.
 
 
 5. Сделайте DNS-сервер сервером по умолчанию для хоста server и внутренней виртуальной сети. Дляэтоготребуется изменитьнастройкисетевогосоединенияeth0
 в NetworkManager, переключивегонаработусвнутреннейсетьюиуказавдлянего
 в качестве DNS-серверапоумолчаниюадрес127.0.0.1

   ![ Сделайте DNS-сервер сервером по умолчанию для хоста server  ](image/2.5.jpg){#fig-014 width=70%} 
 
 6. СделайтетожесамоедлясоединенияSystem eth0 (еслионоактивно):

   ![ Установка DNS-сервера сервером по умолчанию для соединения System eth0   ](image/2.6.jpg){#fig-015 width=70%} 
 
 7. ПерезапуститеNetworkManager:
 systemctl restart NetworkManager
 
    ![ изменения в файле /etc/resolv.conf. ](image/2.7.jpg){#fig-016 width=70%}
  
 
 8. Требуется настроить направление DNS-запросов от всех узлов внутренней сети,
 включаязапросыотузлаserver,черезузелserver.Дляэтоговнеситеизменения
 в файл/etc/named.conf

![ изменения в файл/etc/named.conf,  ](image/2.8.jpg){#fig-017 width=70%}

 9. Внесите изменениявнастройкимежсетевогоэкранаузлаserver,разрешивработу
 с DNS:

![  изменениявнастройкимежсетевогоэкранаузлаserver,разрешивработу с DNS: ](image/2.9.jpg){#fig-018 width=70%}


 10. Убедитесь, чтоDNS-запросыидутчерезузелserver,которыйпрослушиваетпорт  53. Дляэтогонаданномэтапеиспользуйтекомандуlsof:
 lsof | grep UDP

![  DNS-запросыидутчерезузелserver,которыйпрослушиваетпорт  53.  ](image/2.10.jpg){#fig-019 width=70%}


Команда lsof | grep UDP выводит список всех активных UDP-соединений и процессов, которые их используют, показывая для каждого из них ключевую информацию: имя команды (COMMAND), идентификатор процесса (PID), пользователя (USER), который его запустил, файловый дескриптор (FD) — часто это цифра или значение типа u для UDP-сокета, тип объекта (TYPE) — обычно IPv4 или IPv6, размер дескриптора (DEVICE) — часто представленный как размер пакета, и самое важное — адреса (NODE), где отображаются локальный адрес и порт (например, *:68 для DHCP-клиента) и удалённый адрес и порт, если соединение установлено. Этот вывод критически важен для системного администратора, так как позволяет быстро идентифицировать, какие службы (например, DNS-резолверы, NTP-клиенты, DHCP-серверы, игровые или медиа-серверы) используют UDP-трафик, на каких портах они работают, и обнаружить потенционно неавторизованные или подозрительные сетевые активности в системе.

11.  В случае возникновения в сети ситуации, когда DNS-запросы от сервера филь
труютсясетевымоборудованием,следуетдобавитьперенаправлениеDNS-запросов
 на конкретный вышестоящий DNS-сервер. Для этого в конфигурационный файл
 named.conf в секциюoptions следуетдобавить
 forwarders { список DNS-серверов };
 forward first;
 ТекущийсписокDNS-серверовможнополучить,введяналокальномхосте(накото
ромразвёртываетсяобразвиртуальноймашины)следующуюкоманду:
 cat /etc/resolv.

![  named.conf  ](image/2.11.jpg){#fig-020 width=70%}
 
![  Текущий списокDNS-серверов  ](image/2.12.jpg){#fig-021 width=70%}
   
   
## 3. Конфигурирование первичного DNS-сервера

 1. СкопируйтешаблонописанияDNS-зонnamed.rfc1912.zones изкаталога/etc вка
талог /etc/named и переименуйтееговuser.net (вместоuser укажитесвойлогин):


 ![ Работа с файлом  ](image/3.1.jpg){#fig-022 width=70%}
 
 2. Включите файл описания зоны/etc/named/user.net вконфигурационномфайле
 DNS/etc/named.conf, добавив внёмвконцестроку:
 include "/etc/named/user.net";
 
 ![  изменение файла, добавление информации ](image/3.2.jpg){#fig-023 width=70%}
 
 
 3. Откройтефайл/etc/named/user.net наредактирование
 
Отредактированный файл имеет вид: 

![  mvchetvergova.net  ](image/3.3.jpg){#fig-024 width=70%}
 
4. Вкаталоге/var/named создайтеподкаталогиmaster/fz иmaster/rz,вкоторыхбудут
 располагаться файлыпрямойиобратнойзонысоответственно:

![  подкаталогиmaster/fz иmaster/rz  ](image/3.4.jpg){#fig-025 width=70%} 
 
 5. Скопируйте шаблон прямой DNS-зоны named.localhost из каталога
 /var/named в каталог /var/named/master/fz и переименуйтееговuser.net (вместо
 user укажитесвойлогин):
 
 ![  копирование  ](image/3.5.jpg){#fig-026 width=70%}
 
 6. Изменитефайл/var/named/master/fz/user.net, указав необходимыеDNS-записи
 для прямойзоны.
 
 ![  изменения в файле  ](image/3.6.jpg){#fig-027 width=70%}

 7. Скопируйте шаблон обратной DNS-зоны named.loopback из каталога
 /var/named в каталог /var/named/master/rz и переименуйтеегов192.168.1:

![  копирование ](image/3.7.jpg){#fig-028 width=70%} 
 
 8. Изменитефайл/var/named/master/rz/192.168.1, указав необходимыеDNS-записи
 для обратной зоны. 

![  изменение файла  ](image/3.8.jpg){#fig-029 width=70%}


 9. Далее требуется исправить права доступа к файлам в каталогах /etc/named
 и/var/named, чтобы демон named могснимиработать:

![  исправление прав доступа ](image/3.9.jpg){#fig-030 width=70%}
 
 10. ВсистемахсзапущеннымSELinuxвсепроцессыифайлыимеютспециальныеметки
 безопасности (так называемый«контекстбезопасности»), используемые системой
 дляпринятиярешенийподоступукэтимпроцессамифайлам.Послеизменения
 доступа кконфигурационнымфайламnamed требуетсякорректновосстановитьих
 меткивSELinux:
 restorecon-vR /etc
 restorecon-vR /var/named
 ДляпроверкисостоянияпереключателейSELinux,относящихсякnamed,введите:
 getsebool-a | grep named
 Принеобходимостидайтеnamed разрешениеназаписьвфайлыDNS-зоны:
 setsebool named_write_master_zones 1
 setsebool-P named_write_master_zones 1
 
 ![  Работа с файлами ](image/3.10.jpg){#fig-031 width=70%}
 
 
 11. Водополнительномтерминалезапуститеврежимереальноговременирасширен
ныйлогсистемныхсообщений,чтобыпроверитькорректностьработысистемы:
 journalctl-x-f
 ивпервомтерминалеперезапуститеDNS-сервер:
 systemctl restart named
 Есливлогевыдаютсясообщенияобошибках,тоустранитеихиповторноперезапу
стите DNS-сервер.

![ дополнительный терминал ](image/3.11.1.jpg){#fig-032 width=70%}


![ Корректная работа named после исправлений скриптов  ](image/3.11.2.jpg){#fig-033 width=70%}

## 4. АнализработыDNS-сервера

 1. Припомощиутилитыdig получитеописаниеDNS-зоныссервераns.user.net (вме
сто user долженбытьуказанвашлогин): dig ns.mvchetvergova.net  ипроанализируйте его.

![ вывод информации ](image/4.1.jpg){#fig-034 width=70%}


 2. Припомощиутилитыhost проанализируйтекорректностьработыDNS-сервера:

![ проверка корректности работы сервера ](image/4.2.jpg){#fig-035 width=70%}

Успешно!


##5.  Внесение изменений в настройки внутреннего окружения виртуальной машины

 1. На виртуальной машине server перейдите в каталог для внесения изменений
 в настройкивнутреннегоокружения/vagrant/provision/server/,создайтевнём
 каталог dns, в которыйпоместитевсоответствующиекаталогиконфигурационные
 файлыDNS
 
 ![ создание топологии ](image/5.1.jpg){#fig-036 width=70%}
 
  2. Вкаталоге/vagrant/provision/server создайте исполняемыйфайлdns.sh:
 touch dns.sh
 chmod +x dns.sh
 
  ![ создание файла, изменение его прав доступа ](image/5.2.1.jpg){#fig-037 width=70%}
 
 
 
 Открыв его на редактирование, пропишите в нём следующий скрипт:
 
  ![ скрипт файла ](image/5.2.2.jpg){#fig-038 width=70%}
 
 
  Этот скрипт, по сути, повторяет произведённые вами действия по установке
 и настройке DNS-сервера: подставляет в нужные каталоги подготовленные ва
миконфигурационныефайлы;меняетсоответствующимобразомправадоступа,
 меткибезопасностиSELinuxиправиламежсетевогоэкрана;настраиваетсетевое
 соединение так, чтобы сервер выступал DNS-сервером по умолчанию для узлов
 внутреннейвиртуальнойсети;запускаетDNS-сервер.


 3. Дляотработкисозданногоскриптавовремязагрузкивиртуальноймашиныserver
 в конфигурационномфайлеVagrantfile необходимодобавитьвразделеконфигу
рациидлясервера:

 ![ изменение в файле Vagrantfile ](image/5.3.jpg){#fig-039 width=70%}
 


# Выводы

В ходе выполнения лабораторной работы №2 были приобретены практические навыки по установке и конфигурированию DNS-сервера, усвоила принцип работы системы доменных имён.



# Список литературы{.unnumbered}

1.  Barr D. Common DNS Operational and Configuration Errors: RFC / RFC Editor. —02/1996. — DOI: 10.17487/rfc1912.
2.  Security-Enhanced Linux. Linux с улучшенной безопасностью: руководство пользователя / M. McAllister, S. Radvan, D. Walsh, D. Grift, E. Paris, J. Morris. — URL: https://docs-old.fedoraproject.org/ru-RU/Fedora/13/html/Security-Enhanced_Linux/index.html (дата обр.13.09.2021).
3. Systemd. — 2015. — URL: https:/ /wiki .archlinux .org /index .php /Systemd (visited on 09/13/2021).
4. Костромин В. А. Утилита lsof — инструмент администратора. — URL: http : / / rus linux.net/kos.php?name=/papers/lsof/lsof.html (дата обр. 13.09.2021).
5. Поттеринг Л. Systemd для администраторов: цикл статей. — 2010. — URL: http : wiki.opennet.ru/Systemd (дата обр. 13.09.2021).
6. Сайт проекта NetworkManager. — URL: https : / / wiki . gnome . org / Projects /
NetworkManager (visited on 09/13/2021).
7. Сайт проекта nmcli. — URL: https://developer.gnome.org/NetworkManager/stable/
nmcli.html (visited on 09/13/2021).
